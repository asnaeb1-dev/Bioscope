<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Chat App</title>
    </head>
    <body>
        <h1>Hello!</h1>
        <label for="file">Downloading progress:</label>
        <progress id="progress" value="0" max="100"> 0%</progress>
        <br>
        <input type='file' id='selectFile'/>
        <br>
        <br>
        <input type="text" id='movie_bar'/>
        <button>Search</button>
        <button id='push'>Push</button>
        <div id='confirm-info'>

        </div>

    </body>
    <!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/7.14.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.12.0/firebase-storage.js"></script>

<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
<script src="https://www.gstatic.com/firebasejs/7.14.1/firebase-analytics.js"></script>

<script>
  // Your web app's Firebase configuration
    var firebaseConfig = {
        apiKey: "AIzaSyC6hIDmXIMwQHDxS8bqgVDO49178Rp5AOU",
        authDomain: "bioscope-6d934.firebaseapp.com",
        databaseURL: "https://bioscope-6d934.firebaseio.com",
        projectId: "bioscope-6d934",
        storageBucket: "bioscope-6d934.appspot.com",
        messagingSenderId: "253621047295",
        appId: "1:253621047295:web:0b96de0ad0f876db0261ca",
        measurementId: "G-8RR2NZKB2V"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

    firebase.analytics();

    const fileButton = document.querySelector('input');
    const progressBar = document.querySelector('progress');

    const searchButton = document.querySelector('button');
    const searchField = document.querySelector('#movie_bar');
    const info_bar = document.querySelector("#confirm-info");
    const push_info = document.querySelector('#push');

    const base_url = 'http://localhost:3000/movie/search'

    var movie = null;

    searchButton.addEventListener('click', (event) => {

    fetch(`${base_url}?name=${searchField.value}`)
        .then(response => response.json())
        .then(result => {
            const res = result.results;
            
            res.forEach(movie => {
                const node = document.createElement("li");
                node.value = movie.title;
                const textnode = document.createTextNode(movie.title)
                node.appendChild(textnode)
                info_bar.appendChild(node);
                node.addEventListener('click', (event) => {
                    console.log(node.childNodes[0].nodeValue)

                })
            })
        })
        .catch(error => console.log(error))
    })

    fileButton.addEventListener('change', function(event) {
        
        const fileSelected = event.target.files[0];
        let ref = firebase.storage().ref('movie/'+fileSelected.name)
        let uploadTask = ref.put(fileSelected)
        
        uploadTask.on('state_changed', function progress(snapshot){
            let percent = (snapshot.bytesTransferred/snapshot.totalBytes)*100;
            console.log(percent)
            progressBar.value = percent
        }, function error(err){
            console.log(err);
        }, function complete(){
            uploadTask.snapshot.ref.getDownloadURL().then(url => movie.url = url).catch(e => console.log(e));
        })
    })

    push_info.addEventListener('click', (event) => {
        console.log(movie);
        fetch('http://localhost:3000/movie/push', {
            method: "POST",
            body: JSON.stringify(movie),
            headers: { 
                "Content-type": "application/json"
            }
            //ATTACH AUTHORIZATION .... ? 
        }).then(response => response.json())
        .catch(e => console.log(e))
    })

</script>
</html>